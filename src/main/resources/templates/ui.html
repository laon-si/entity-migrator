<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Schema GUI</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .entity { border: 1px solid #ddd; margin: 8px 0; padding: 8px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    input[type=text], select { width: 100%; }
  </style>
</head>
<body>
<h1>Entity Schema Migrator - GUI</h1>
<button onclick="load()">Load Entities</button>
<div id="entities"></div>
<button onclick="saveAll()">Save All Changes</button>
<pre id="log"></pre>

<script>
    let entities = [];

    async function load() {
        const res = await fetch('/api/scan/entities');
        const data = await res.json();
        entities = data.entities || [];
        render();
    }

    function render() {
        const container = document.getElementById('entities');
        container.innerHTML = '';
        entities.forEach(ent => {
            const div = document.createElement('div');
        div.className = 'entity';

        // 제목
        const title = document.createElement('h2');
        title.textContent = ent.className + ' (table: ' + ent.tableName + ')';
        div.appendChild(title);

        // 새 테이블명 입력
        div.innerHTML += '<label>새 테이블명: </label>'
            + '<input type="text" id="'+ent.qualifiedName+'_table"/><br/><br/>';

        // 필드 테이블
        const tbl = document.createElement('table');
        const header = document.createElement('tr');
        header.innerHTML = '<th>Field</th><th>Column</th><th>New Column</th>'
            + '<th>Type</th><th>New Type</th><th>PK</th><th>New PK</th>';
        tbl.appendChild(header);

        ent.fields.forEach(f => {
            const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + f.fieldName + '</td>'
            + '<td>' + f.columnName + '</td>'
            + '<td><input id="'+ent.qualifiedName+'_'+f.fieldName+'_col"/></td>'
            + '<td>' + f.type + '</td>'
            + '<td><input id="'+ent.qualifiedName+'_'+f.fieldName+'_type"/></td>'
            + '<td>' + (f.primaryKey ? 'Y' : '') + '</td>'
            + '<td><input type="checkbox" id="'+ent.qualifiedName+'_'+f.fieldName+'_pk"/></td>';
        tbl.appendChild(tr);
    });
        div.appendChild(tbl);

        // 개별 엔티티 저장 버튼
        div.innerHTML += '<button onclick="saveEntity(\''+ent.qualifiedName+'\')">저장</button>';

        container.appendChild(div);
    });
    }

    // 개별 엔티티 저장
    async function saveEntity(qualifiedName) {
        const ent = entities.find(e => e.qualifiedName === qualifiedName);
        let newTableName = document.getElementById(qualifiedName+'_table').value;

        let fields = [];
        ent.fields.forEach(f => {
            fields.push({
            fieldName: f.fieldName,
            newColumnName: document.getElementById(qualifiedName+'_'+f.fieldName+'_col').value,
            newType: document.getElementById(qualifiedName+'_'+f.fieldName+'_type').value,
            primaryKey: document.getElementById(qualifiedName+'_'+f.fieldName+'_pk').checked
        });
    });

        let payload = {
            qualifiedName: qualifiedName,
            newTableName: newTableName,
            fields: fields
        };

        const res = await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const text = await res.text();
        alert(text);
    }

    // 전체 저장 (엑셀 업로드 로직 대신 확장용)
    async function saveAll() {
        document.getElementById('log').textContent = '전체 저장은 아직 개별 저장 방식만 지원합니다.';
    }
</script>
</body>
</html>
